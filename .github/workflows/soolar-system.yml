name: Solar Syatem Workflow

on:
    workflow_dispatch: 
    push: 
        branches: 
            - main
            - 'feature/*'
env: 
    MONGO_URI: 'mongodb+srv://supercluster.d83jj.mongodb.net/superData'
    MONGO_USERNAME: ${{ vars.MONGO_USERNAME }}
    MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
jobs: 
    unit-testing: 
        name: Unit Testing
        strategy:
          matrix:
            nodejs_version: [18, 19, 20]
            os: [ubuntu-latest, macos-latest]
            exclude:
              - nodejs_version: 18
                os: macos-latest

        runs-on: ${{ matrix.os}}
        steps:
           - name: Checkout Repo
             uses: actions/checkout@v4

           - name: Setup NodeJS Version - ${{ matrix.nodejs_version }}
             uses: actions/setup-node@v3
             with:
                node-version: ${{ matrix.nodejs_version }}

           - name: install Dependencies
             run: npm install

           - name: Unit Testing
             run: npm test

           - name: Archive Test Results
             if: always()
             uses: actions/upload-artifact@v3
             with:
                name: Mocah-Test-Result
                path: test-results.xml
    
    code-coverage: 

        name: Code Coverage
        runs-on: ubuntu-latest
        steps:
           - name: Checkout Repo
             uses: actions/checkout@v4

           - name: Setup NodeJS Version - 18
             uses: actions/setup-node@v3
             with:
                node-version: 18

           - name: install Dependencies
             run: npm install

           - name: check code coverage
             continue-on-error: true
             run: npm run coverage

           - name: Archive Test Results
             uses: actions/upload-artifact@v3
             with:
                name: code-coverage-Result
                path: coverage
                retention-days: 5

    docker:
        name: Containarization
        needs: [unit-testing, code-coverage]
        runs-on: unbuntu-latest
        steps:
            - name: checkout
              uses: actions/checkout@v4

            - name: Dockerhub Login
              uses: docker/login-actions@v2.2.0
              with:
                username: $ {{ vars.DOCKERHUB_USERNAME }}
                password: $ {{ secrets.DOCKERHUB_PASSWORD }}

